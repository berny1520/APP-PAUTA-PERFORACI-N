<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Evaluaciones – Operadores</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // FIX: Chart.js siempre responsivo y sin forzar alto excesivo
  if (window.Chart && Chart.defaults) {
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    Chart.defaults.animation = false;
  }
</script>

  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    
.brand{display:flex;align-items:center;gap:12px}
.brand-logo{height:44px;width:auto;max-width:180px;object-fit:contain;display:block}
.brand-title{font-weight:800;font-size:18px;line-height:1.1}
.brand-sub{font-size:12px;color:#6b7280;margin-top:2px}
body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; }
    header {
      background:#111827; color:white; padding:14px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand {
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.3px;
    }
    .brand small { display:block; font-weight:400; opacity:.85; margin-top:2px;}
    .container { padding:16px; max-width:1400px; margin:0 auto; }
    .toolbar {
      background:white; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .toolbar label { font-size:12px; color:#374151; font-weight:600; }
    .toolbar input, .toolbar select {
      padding:7px 10px; border:1px solid #d1d5db; border-radius:7px; outline:none;
      font-size:13px; background:white;
    }
    .btn {
      border:none; padding:8px 12px; border-radius:7px; cursor:pointer; font-weight:700;
      font-size:13px;
    }
    .btn-primary { background:#ef4444; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .btn-success { background:#16a34a; color:white; }

    .grid-kpis {
      display:grid; grid-template-columns: repeat(6, minmax(160px, 1fr));
      gap:10px; margin-top:12px;
    }
    .kpi {
      background:white; border-radius:10px; padding:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
      border-left:4px solid #ef4444;
    }
    .kpi .label { font-size:11px; color:#6b7280; font-weight:700; text-transform:uppercase; }
    .kpi .value { font-size:20px; font-weight:800; margin-top:6px; color:#111827; }
    .kpi .sub { font-size:11px; color:#6b7280; margin-top:4px; }

    .grid-charts {
      margin-top:12px;
      display:grid; grid-template-columns: 2fr 1fr;
      gap:10px;
    }
    .card {
      background:white; border-radius:10px; padding:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .card h3 { margin:0 0 10px 0; font-size:14px; color:#111827; }
    .grid-bottom {
      margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 6px; font-size:12px; border-bottom:1px solid #e5e7eb; }
    th { text-align:left; background:#f9fafb; position:sticky; top:0; z-index:1; }
    .table-wrap { max-height:320px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }

    .notice {
      background: #fff7ed; border:1px solid #fed7aa; color:#9a3412;
      padding:10px 12px; border-radius:10px; margin-top:12px; display:none;
      font-size:13px;
    }

    @media (max-width: 1200px){
      .grid-kpis { grid-template-columns: repeat(3, minmax(160px, 1fr)); }
      .grid-charts { grid-template-columns: 1fr; }
      .grid-bottom { grid-template-columns: 1fr; }
    }
  

/* --- FIX: evitar desborde de gráficos (Chart.js) --- */
.chart-card { overflow: hidden; }
.chart-wrap{
  position: relative;
  width: 100%;
  height: 340px;          /* altura estándar desktop */
  min-height: 340px;
}
.chart-wrap.small{ height: 280px; min-height: 280px; }
.chart-wrap.tall{ height: 420px; min-height: 420px; }

.chart-wrap canvas{
  position: absolute;
  inset: 0;
  width: 100% !important;
  height: 100% !important;
  max-width: 100% !important;
  max-height: 100% !important;
}

@media (max-width: 1200px){
  .chart-wrap{ height: 300px; min-height: 300px; }
}
@media (max-width: 768px){
  .chart-wrap{ height: 260px; min-height: 260px; }
}

.grid-top,.grid-mid,.grid-bottom{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
.grid-bottom{grid-template-columns:repeat(1,minmax(0,1fr))}
.chart-wrap{position:relative;height:340px;width:100%;overflow:hidden}
.chart-wrap canvas{max-width:100% !important;max-height:100% !important}
.card{overflow:hidden}
.table-card{margin-top:14px}
.table-wrap{overflow:auto;max-width:100%}
</style>
</head>

<body>
<header>
  <div class="brand">
    <img class="brand-logo" src="data:image/png;base64,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" alt="Xtreme Mining">
    <div class="brand-text">
      <div class="brand-title">Dashboard Evaluaciones – Operadores</div>
      <div class="brand-sub">Creado por Bernardo Ojeda Molina – Jefe de Innovación y Formación</div>
    </div>
  </div>
</div>
</div>

  <div class="grid-charts">
    <div class="card chart-card">
      <h3>Nota final por operador (Top 20)</h3>
      <div class="chart-wrap"><canvas id="chartNotaOperador"></canvas></div>
    </div>
    <div class="card chart-card">
      <h3>Promedio nota por equipo</h3>
      <div class="chart-wrap"><canvas id="chartPromEquipo"></canvas></div>
    </div>
  </div>

  <div class="grid-bottom">
<div class="card chart-card">
      <h3>Total puntos por operador (Top 20)</h3>
      <div class="chart-wrap"><canvas id="chartPuntosOperador"></canvas></div>
    </div>
</div>

<div class="card table-card">
<h3>Detalle de registros</h3>

      <div class="table-wrap">
        <table id="tabla-detalle">
          <thead>
            <tr>
              <th>RUT</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Cargo</th>
              <th>Equipo</th>
              <th>Contrato</th>
              <th>Instructor</th>
              <th>Total puntos</th>
              <th>Nota final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:8px;">
        <button class="btn btn-secondary" onclick="prevPage()">◀</button>
        <span id="pageInfo" style="font-size:12px;color:#666;">Página 1</span>
        <button class="btn btn-secondary" onclick="nextPage()">▶</button>

        <select id="pageSize" onchange="setPageSize(this.value)"
          style="padding:5px 7px;border-radius:7px;border:1px solid #d1d5db;font-size:12px;">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
</div>
  </div>

</div>

<script>
  /******************************************************************
   * ✅ 1) PEGA AQUÍ TUS LINKS CSV PUBLICADOS
   *
   *  IMPORTANTE:
   *  - NO uses links /edit?gid=...
   *  - Debe ser /pub?gid=...&single=true&output=csv
   *
   *  Cómo obtenerlos:
   *  Google Sheets → Archivo → Publicar en la web → CSV → copiar link.
   ******************************************************************/
  const CSV_URLS = [
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv2nHTgf2UJjzyxQs0e79UCLz2lRIyGO9AR4y_2p9Nq61lQ0sErMa9IakEDKy_6b4F1V2shvuu3AZQ/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWu_RoFhoxPb3mLa3G8OhapNtWzLoIYMtdVzTJJzBLeEyxsOYtJRmtycgL6kpsE3Pkww3OwQow8baM/pub?gid=764665870&single=true&output=csv",
     ];

  // Estado global
  let registrosBase = [];
  let registrosActuales = [];

  // Paginación
  let page = 1;
  let pageSize = 25;

  // Charts
  let chartNotaOperador = null;
  let chartPuntosOperador = null;
  let chartPromEquipo = null;

  // Chart.js defaults
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.responsive = true;

  function showNotice(msg){
    const n = document.getElementById("notice");
    n.style.display = "block";
    n.textContent = msg;
  }
  function hideNotice(){
    const n = document.getElementById("notice");
    n.style.display = "none";
    n.textContent = "";
  }

  /**************** CSV Helpers ****************/
  function parseCSV(text) {
    // parser simple (maneja comillas)
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const n = text[i + 1];

      if (c === '"' && inQuotes && n === '"') { // "" -> "
        cur += '"'; i++;
      } else if (c === '"') {
        inQuotes = !inQuotes;
      } else if (c === "," && !inQuotes) {
        row.push(cur); cur = "";
      } else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && n === "\n") i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) {
      row.push(cur);
      rows.push(row);
    }

    // limpia filas vacías
    return rows.filter(r => r.some(x => (x ?? "").toString().trim() !== ""));
  }

  function normalizarHeader(h) {
    return (h || "")
      .toString()
      .trim()
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/[_-]+/g, " ");
  }

  function pickIndex(headersNorm, aliases) {
    for (const a of aliases) {
      const idx = headersNorm.indexOf(normalizarHeader(a));
      if (idx !== -1) return idx;
    }
    return -1;
  }

  function toNumberSafe(v) {
    const s = (v ?? "").toString().trim();
    if (!s) return 0;

    const cleaned = s
      .replace(/\s/g, "")
      .replace(/\.(?=\d{3}(\D|$))/g, "")
      .replace(",", ".");

    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function mapearDesdeSheet(rows, meta = { source: "Fuente" }) {
    if (!rows || !rows.length) return [];

    const headers = rows[0] || [];
    const headersNorm = headers.map(normalizarHeader);

    const iRUT        = pickIndex(headersNorm, ["RUT", "RUN"]);
    const iNOMBRE     = pickIndex(headersNorm, ["NOMBRE", "NOMBRE Y APELLIDO", "NOMBRES", "OPERADOR"]);
    const iFECHA      = pickIndex(headersNorm, ["FECHA", "FECHA EVALUACION", "TIMESTAMP", "HORA", "FECHA Y HORA"]);
    const iCARGO      = pickIndex(headersNorm, ["CARGO", "ROL"]);
    const iEQUIPO     = pickIndex(headersNorm, ["EQUIPO", "MAQUINA", "EQUIPO EVALUADO"]);
    const iCONTRATO   = pickIndex(headersNorm, ["CONTRATO", "PROYECTO", "FAENA"]);
    const iINSTRUCTOR = pickIndex(headersNorm, ["INSTRUCTOR", "EVALUADOR", "SUPERVISOR"]);
    const iTOTAL      = pickIndex(headersNorm, ["TOTALPUNTOS", "TOTAL PUNTOS", "TOTAL_PUNTOS", "PUNTOS", "TOTAL"]);
    const iNOTA       = pickIndex(headersNorm, ["NOTAFINAL", "NOTA FINAL", "NOTA_FINAL", "NOTA", "CALIFICACION"]);

    if ([iRUT, iNOMBRE, iTOTAL, iNOTA].some(i => i === -1)) {
      console.warn("Fuente ignorada por columnas mínimas faltantes:", meta.source, {
        headers_originales: headers,
        headers_normalizados: headersNorm,
        requeridas: { iRUT, iNOMBRE, iTOTAL, iNOTA }
      });
      return [];
    }

    const dataRows = rows
      .slice(1)
      .filter(r => r && (r[iRUT] || "").toString().trim() !== "");

    return dataRows.map(r => ({
      source: meta.source,
      rut:        (r[iRUT]        || "").toString().trim(),
      nombre:     (r[iNOMBRE]     || "").toString().trim(),
      fecha:      (r[iFECHA]      || "").toString().trim(),
      cargo:      (r[iCARGO]      || "").toString().trim(),
      equipo:     (r[iEQUIPO]     || "").toString().trim(),
      contrato:   (r[iCONTRATO]   || "").toString().trim(),
      instructor: (r[iINSTRUCTOR] || "").toString().trim(),
      totalPuntos: toNumberSafe(r[iTOTAL]),
      notaFinal:   toNumberSafe(r[iNOTA])
    }));
  }

  /**************** Carga de datos ****************/
  function validarURLs(){
    if (!CSV_URLS.length) {
      showNotice("No hay URLs en CSV_URLS. Pega tus links CSV publicados (Archivo → Publicar en la web → CSV).");
      return false;
    }
    for (const u of CSV_URLS) {
      if (u.includes("...")) {
        showNotice("Una URL tiene '...'. Eso rompe la carga. Pega el link completo CSV publicado.");
        return false;
      }
      if (u.includes("/edit")) {
        showNotice("Estás usando un link /edit. Debe ser /pub?...&output=csv (Publicar en la web).");
        return false;
      }
      if (!u.includes("output=csv")) {
        showNotice("Una URL no parece CSV (falta output=csv). Revisa el link publicado.");
        return false;
      }
    }
    hideNotice();
    return true;
  }

  async function cargarDatosMultiples() {
    if (!validarURLs()) return;

    try {
      const resultados = await Promise.all(
        CSV_URLS.map(async (url) => {
          const res = await fetch(url, { cache: "no-store" });
          const txt = await res.text();
          return { url, txt, ok: res.ok, status: res.status };
        })
      );

      let todos = [];
      resultados.forEach(({url, txt, ok, status}, idx) => {
        const rows = parseCSV(txt);
        const mapped = mapearDesdeSheet(rows, { source: `Sheet ${idx+1}` });

        console.log(`Fuente ${idx+1}`, { ok, status, url, filasCSV: rows.length, registrosMapeados: mapped.length });
        todos = todos.concat(mapped);
      });

      registrosBase = todos;
      console.log("Registros combinados cargados:", registrosBase.length);

      if (!registrosBase.length) {
        showNotice("Cargó 0 registros. Abre F12 → Console y mira si alguna fuente quedó ignorada por columnas.");
      } else {
        hideNotice();
      }

      poblarFiltros(registrosBase);
      aplicarFiltros();

    } catch (err) {
      console.error("Error cargando datos:", err);
      showNotice("Error al leer las bases (probable CORS/permisos). Si abriste el archivo como file://, prueba abrirlo con un servidor local (http://localhost) o usa el botón \"Cargar CSV local\".");
    }
  }

  /**************** Filtros ****************/
  function poblarFiltros(reg) {
    const equipoSel = document.getElementById("equipoSel");
    const contratoSel = document.getElementById("contratoSel");
    const instructorSel = document.getElementById("instructorSel");

    const uniq = (arr) => [...new Set(arr.filter(Boolean).map(x => x.toString().trim()))].sort();

    const equipos = ["Todos", ...uniq(reg.map(r => r.equipo))];
    const contratos = ["Todos", ...uniq(reg.map(r => r.contrato))];
    const instructores = ["Todos", ...uniq(reg.map(r => r.instructor))];

    equipoSel.innerHTML = equipos.map(x => `<option>${x}</option>`).join("");
    contratoSel.innerHTML = contratos.map(x => `<option>${x}</option>`).join("");
    instructorSel.innerHTML = instructores.map(x => `<option>${x}</option>`).join("");

    equipoSel.onchange = aplicarFiltros;
    contratoSel.onchange = aplicarFiltros;
    instructorSel.onchange = aplicarFiltros;
  }

  function aplicarFiltros() {
    const rutQ = document.getElementById("rutInput").value.trim().toUpperCase();
    const equipo = document.getElementById("equipoSel").value;
    const contrato = document.getElementById("contratoSel").value;
    const instructor = document.getElementById("instructorSel").value;

    let f = [...registrosBase];

    if (rutQ) f = f.filter(r => (r.rut || "").toUpperCase().includes(rutQ));
    if (equipo && equipo !== "Todos") f = f.filter(r => r.equipo === equipo);
    if (contrato && contrato !== "Todos") f = f.filter(r => r.contrato === contrato);
    if (instructor && instructor !== "Todos") f = f.filter(r => r.instructor === instructor);

    registrosActuales = f;

    // reset page al filtrar
    page = 1;

    actualizarKPIs(registrosActuales);
    dibujarGraficos(registrosActuales);
    dibujarTabla(registrosActuales);
  }

  function limpiarFiltros() {
    document.getElementById("rutInput").value = "";
    document.getElementById("equipoSel").value = "Todos";
    document.getElementById("contratoSel").value = "Todos";
    document.getElementById("instructorSel").value = "Todos";
    aplicarFiltros();
  }

  function buscarRut() {
    aplicarFiltros();
  }

  /**************** KPIs ****************/
  function actualizarKPIs(reg) {
    document.getElementById("kpiRegistros").textContent = reg.length.toString();

    const uniqOp = new Set(reg.map(r => (r.rut || "") + "|" + (r.nombre || "")));
    document.getElementById("kpiOperadores").textContent = uniqOp.size.toString();

    const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

    const notas = reg.map(r => r.notaFinal || 0).filter(x => Number.isFinite(x));
    const puntos = reg.map(r => r.totalPuntos || 0).filter(x => Number.isFinite(x));

    document.getElementById("kpiPromNota").textContent = avg(notas).toFixed(1);
    document.getElementById("kpiPromPuntos").textContent = avg(puntos).toFixed(1);

    document.getElementById("kpiEquipos").textContent = new Set(reg.map(r => r.equipo).filter(Boolean)).size.toString();
    document.getElementById("kpiContratos").textContent = new Set(reg.map(r => r.contrato).filter(Boolean)).size.toString();
  }

  /**************** Gráficos ****************/
  function destroyChart(ch){ if (ch) ch.destroy(); }

  function dibujarGraficos(reg) {
    // Top 20 por nota
    const top = [...reg].sort((a,b)=> (b.notaFinal||0)-(a.notaFinal||0)).slice(0, 20);

    const labelsOper = top.map(r => (r.nombre || r.rut || "Sin nombre"));
    const notasOper = top.map(r => r.notaFinal || 0);
    const puntosOper = top.map(r => r.totalPuntos || 0);

    // Promedio por equipo
    const porEquipo = {};
    reg.forEach(r => {
      const k = r.equipo || "Sin equipo";
      porEquipo[k] = porEquipo[k] || { sum:0, n:0 };
      porEquipo[k].sum += (r.notaFinal || 0);
      porEquipo[k].n += 1;
    });
    const equipos = Object.keys(porEquipo);
    const promEquipo = equipos.map(k => porEquipo[k].n ? (porEquipo[k].sum/porEquipo[k].n) : 0);

    destroyChart(chartNotaOperador);
    destroyChart(chartPuntosOperador);
    destroyChart(chartPromEquipo);

    chartNotaOperador = new Chart(document.getElementById("chartNotaOperador"), {
      type: "bar",
      data: { labels: labelsOper, datasets: [{ label: "Nota final", data: notasOper }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true, max:100 } }
      }
    });

    chartPuntosOperador = new Chart(document.getElementById("chartPuntosOperador"), {
      type: "bar",
      data: { labels: labelsOper, datasets: [{ label: "Total puntos", data: puntosOper }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true } }
      }
    });

    chartPromEquipo = new Chart(document.getElementById("chartPromEquipo"), {
      type: "bar",
      data: { labels: equipos, datasets: [{ label: "Promedio nota", data: promEquipo }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true, max:100 } }
      }
    });
  }

  /**************** Tabla + paginación ****************/
  function setPageSize(v){
    pageSize = Number(v) || 25;
    page = 1;
    dibujarTabla(registrosActuales);
  }
  function prevPage(){
    if (page > 1) { page--; dibujarTabla(registrosActuales); }
  }
  function nextPage(){
    const totalPages = Math.max(1, Math.ceil(registrosActuales.length / pageSize));
    if (page < totalPages) { page++; dibujarTabla(registrosActuales); }
  }

  function dibujarTabla(reg) {
    const tbody = document.querySelector("#tabla-detalle tbody");
    tbody.innerHTML = "";

    const totalPages = Math.max(1, Math.ceil(reg.length / pageSize));
    if (page > totalPages) page = totalPages;

    const start = (page - 1) * pageSize;
    const slice = reg.slice(start, start + pageSize);

    document.getElementById("pageInfo").textContent =
      `Página ${page} de ${totalPages} — Mostrando ${slice.length} de ${reg.length}`;

    slice.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.rut)}</td>
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.fecha)}</td>
        <td>${esc(r.cargo)}</td>
        <td>${esc(r.equipo)}</td>
        <td>${esc(r.contrato)}</td>
        <td>${esc(r.instructor)}</td>
        <td>${(r.totalPuntos ?? 0)}</td>
        <td>${(r.notaFinal ?? 0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function esc(v){
    return (v ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /**************** Exportar PDF ****************/
  async function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    doc.setFontSize(14);
    doc.text("Dashboard Evaluaciones – Operadores", 40, 40);
    doc.setFontSize(10);
    doc.text("Generado desde el dashboard", 40, 58);

    const head = [["RUT","Nombre","Fecha","Cargo","Equipo","Contrato","Instructor","Total puntos","Nota final"]];
    const body = registrosActuales.map(r => [
      r.rut, r.nombre, r.fecha, r.cargo, r.equipo, r.contrato, r.instructor,
      String(r.totalPuntos ?? 0), String(r.notaFinal ?? 0)
    ]);

    doc.autoTable({
      startY: 80,
      head,
      body,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [17, 24, 39] }
    });

    doc.save("dashboard_evaluaciones.pdf");
  }


  async function cargarCSVsLocales(fileList){
    try{
      hideNotice();
      if(!fileList || !fileList.length){
        showNotice("No seleccionaste archivos CSV.");
        return;
      }
      const files = Array.from(fileList);
      let todos = [];
      for (let i=0;i<files.length;i++){
        const f = files[i];
        const txt = await f.text();
        const rows = parseCSV(txt);
        const mapped = mapearDesdeSheet(rows, { source: f.name || `CSV ${i+1}` });
        console.log("CSV local", { archivo: f.name, filasCSV: rows.length, registrosMapeados: mapped.length });
        todos = todos.concat(mapped);
      }
      registrosBase = todos;
      console.log("Registros combinados (local) cargados:", registrosBase.length);
      if (!registrosBase.length) {
        showNotice("Cargó 0 registros desde CSV local. Revisa que existan columnas mínimas (RUT, NOMBRE, TOTALPUNTOS/TOTAL PUNTOS, NOTAFINAL/NOTA FINAL).");
      } else {
        hideNotice();
      }
      poblarFiltros(registrosBase);
      aplicarFiltros();
    } catch(err){
      console.error("Error leyendo CSV local:", err);
      showNotice("No pude leer tus CSV locales. Abre F12 → Console para ver el error.");
    }
  }

  // Arranque
  window.addEventListener("load", cargarDatosMultiples);
</script>

</body>
</html>
