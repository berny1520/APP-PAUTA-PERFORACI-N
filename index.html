<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Evaluaciones – Operadores</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // FIX: Chart.js siempre responsivo y sin forzar alto excesivo
  if (window.Chart && Chart.defaults) {
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    Chart.defaults.animation = false;
  }
</script>

  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; }
    header {
      background:#111827; color:white; padding:14px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand {
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.3px;
    }
    .brand small { display:block; font-weight:400; opacity:.85; margin-top:2px;}
    .container { padding:16px; max-width:1400px; margin:0 auto; }
    .toolbar {
      background:white; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .toolbar label { font-size:12px; color:#374151; font-weight:600; }
    .toolbar input, .toolbar select {
      padding:7px 10px; border:1px solid #d1d5db; border-radius:7px; outline:none;
      font-size:13px; background:white;
    }
    .btn {
      border:none; padding:8px 12px; border-radius:7px; cursor:pointer; font-weight:700;
      font-size:13px;
    }
    .btn-primary { background:#ef4444; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .btn-success { background:#16a34a; color:white; }

    .grid-kpis {
      display:grid; grid-template-columns: repeat(6, minmax(160px, 1fr));
      gap:10px; margin-top:12px;
    }
    .kpi {
      background:white; border-radius:10px; padding:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
      border-left:4px solid #ef4444;
    }
    .kpi .label { font-size:11px; color:#6b7280; font-weight:700; text-transform:uppercase; }
    .kpi .value { font-size:20px; font-weight:800; margin-top:6px; color:#111827; }
    .kpi .sub { font-size:11px; color:#6b7280; margin-top:4px; }

    .grid-charts {
      margin-top:12px;
      display:grid; grid-template-columns: 2fr 1fr;
      gap:10px;
    }
    .card {
      background:white; border-radius:10px; padding:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .card h3 { margin:0 0 10px 0; font-size:14px; color:#111827; }
    .grid-bottom {
      margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 6px; font-size:12px; border-bottom:1px solid #e5e7eb; }
    th { text-align:left; background:#f9fafb; position:sticky; top:0; z-index:1; }
    .table-wrap { max-height:320px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }

    .notice {
      background: #fff7ed; border:1px solid #fed7aa; color:#9a3412;
      padding:10px 12px; border-radius:10px; margin-top:12px; display:none;
      font-size:13px;
    }

    @media (max-width: 1200px){
      .grid-kpis { grid-template-columns: repeat(3, minmax(160px, 1fr)); }
      .grid-charts { grid-template-columns: 1fr; }
      .grid-bottom { grid-template-columns: 1fr; }
    }
  

/* --- FIX: evitar desborde de gráficos (Chart.js) --- */
.chart-card { overflow: hidden; }
.chart-wrap{
  position: relative;
  width: 100%;
  height: 340px;          /* altura estándar desktop */
  min-height: 340px;
}
.chart-wrap.small{ height: 280px; min-height: 280px; }
.chart-wrap.tall{ height: 420px; min-height: 420px; }

.chart-wrap canvas{
  position: absolute;
  inset: 0;
  width: 100% !important;
  height: 100% !important;
  max-width: 100% !important;
  max-height: 100% !important;
}

@media (max-width: 1200px){
  .chart-wrap{ height: 300px; min-height: 300px; }
}
@media (max-width: 768px){
  .chart-wrap{ height: 260px; min-height: 260px; }
}
</style>
</head>

<body>
<header>
  <div class="brand">
    <div style="width:48px;height:48px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;">
      <img id="logo_Xtreme.png" src="logo_Xtreme.png" alt="logo_Xtreme.png" style="width:100%;height:100%;object-fit:contain;" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='flex';" />
      <div id="logoFallback" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#111827;font-weight:900;">LOGO</div>
    </div>

    <div>
      Dashboard Evaluaciones – Operadores
      <small>Creado por Bernardo Ojeda Molina – Jefe de Innovación y Formación</small>
    </div>
  </div>
</header>

<div class="container">

  <div class="toolbar">
    <label>RUT:</label>
    <input id="rutInput" placeholder="Ej: 12377087-0" />

    <button class="btn btn-primary" onclick="buscarRut()">Buscar</button>

    <label>Equipo:</label>
    <select id="equipoSel"></select>

    <label>Contrato:</label>
    <select id="contratoSel"></select>

    <label>Instructor:</label>
    <select id="instructorSel"></select>

    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar filtros</button>
    <button class="btn btn-success" onclick="exportarPDF()">Exportar PDF</button>
    <button class="btn btn-secondary" onclick="document.getElementById('csvFiles').click()">Cargar CSV local</button>
    <input id="csvFiles" type="file" accept=".csv,text/csv" multiple style="display:none" onchange="cargarCSVsLocales(this.files)" />
  </div>

  <div id="notice" class="notice"></div>

  <div class="grid-kpis">
    <div class="kpi">
      <div class="label">Registros de evaluación</div>
      <div class="value" id="kpiRegistros">0</div>
      <div class="sub">Total de filas con datos</div>
    </div>
    <div class="kpi">
      <div class="label">Operadores únicos</div>
      <div class="value" id="kpiOperadores">0</div>
      <div class="sub">Por RUT / Nombre</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">AVANCE DOTACIÓN</div>
      <div class="kpi-value" id="kpiAvanceDotacion">0.0%</div>
      <div class="kpi-sub" id="kpiDotacionTotal">Sobre dotación total 108</div>
    </div>
      <div class="control">
        <label>Dotación total:</label>
        <input id="dotacionInput" type="number" min="0" step="1" value="108"
               oninput="localStorage.setItem('dotacionTotal', this.value); if (typeof aplicarFiltros==='function') aplicarFiltros();"
               style="width:110px;" />
      </div>
    <div class="kpi">
      <div class="label">Promedio nota final</div>
      <div class="value" id="kpiPromNota">0</div>
      <div class="sub">Columna NOTAFINAL</div>
    </div>
    <div class="kpi">
      <div class="label">Promedio total puntos</div>
      <div class="value" id="kpiPromPuntos">0</div>
      <div class="sub">Columna TOTALPUNTOS</div>
    </div>
    <div class="kpi">
      <div class="label">Equipos distintos</div>
      <div class="value" id="kpiEquipos">0</div>
      <div class="sub">Cantidad de equipos evaluados</div>
    </div>
    <div class="kpi">
      <div class="label">Contratos distintos</div>
      <div class="value" id="kpiContratos">0</div>
      <div class="sub">Cantidad de contratos</div>
    </div>
  </div>

  <div class="grid-charts">
    <div class="card chart-card">
      <h3>Nota final por operador (Top 20)</h3>
      <div class="chart-wrap"><canvas id="chartNotaOperador"></canvas></div>
    </div>
    <div class="card chart-card">
      <h3>Promedio nota por equipo</h3>
      <div class="chart-wrap"><canvas id="chartPromEquipo"></canvas></div>
    </div>
  </div>

  <div class="grid-bottom">
    <div class="card chart-card">
      <h3>Total puntos por operador (Top 20)</h3>
      <div class="chart-wrap"><canvas id="chartPuntosOperador"></canvas></div>
    </div>
    <div class="card chart-card">
      <h3>Detalle de registros</h3>

      <div class="table-wrap">
        <table id="tabla-detalle">
          <thead>
            <tr>
              <th>RUT</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Cargo</th>
              <th>Equipo</th>
              <th>Contrato</th>
              <th>Instructor</th>
              <th>Total puntos</th>
              <th>Nota final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:8px;">
        <button class="btn btn-secondary" onclick="prevPage()">◀</button>
        <span id="pageInfo" style="font-size:12px;color:#666;">Página 1</span>
        <button class="btn btn-secondary" onclick="nextPage()">▶</button>

        <select id="pageSize" onchange="setPageSize(this.value)"
          style="padding:5px 7px;border-radius:7px;border:1px solid #d1d5db;font-size:12px;">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>

    </div>
  </div>

</div>

<script>
  /******************************************************************
   * ✅ 1) PEGA AQUÍ TUS LINKS CSV PUBLICADOS
   *
   *  IMPORTANTE:
   *  - NO uses links /edit?gid=...
   *  - Debe ser /pub?gid=...&single=true&output=csv
   *
   *  Cómo obtenerlos:
   *  Google Sheets → Archivo → Publicar en la web → CSV → copiar link.
   ******************************************************************/
  const CSV_URLS = [
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv2nHTgf2UJjzyxQs0e79UCLz2lRIyGO9AR4y_2p9Nq61lQ0sErMa9IakEDKy_6b4F1V2shvuu3AZQ/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWu_RoFhoxPb3mLa3G8OhapNtWzLoIYMtdVzTJJzBLeEyxsOYtJRmtycgL6kpsE3Pkww3OwQow8baM/pub?gid=764665870&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWu_RoFhoxPb3mLa3G8OhapNtWzLoIYMtdVzTJJzBLeEyxsOYtJRmtycgL6kpsE3Pkww3OwQow8baM/pub?gid=679076850&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWu_RoFhoxPb3mLa3G8OhapNtWzLoIYMtdVzTJJzBLeEyxsOYtJRmtycgL6kpsE3Pkww3OwQow8baM/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUSxs3ofNYlWqoNzIYzat-ffZ3LR441TZjiV41T4Qv_Yg_nf3ZCl5BncCKHLxias_zg9DvhBNBvEXC/pub?gid=0&single=true&output=csv",
     ];

  // Estado global
  let registrosBase = [];
  let registrosActuales = [];

  // Paginación
  let page = 1;
  let pageSize = 25;

  // Charts
  let chartNotaOperador = null;
  let chartPuntosOperador = null;
  let chartPromEquipo = null;

  // Chart.js defaults
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.responsive = true;

  function showNotice(msg){
    const n = document.getElementById("notice");
    n.style.display = "block";
    n.textContent = msg;
  }
  function hideNotice(){
    const n = document.getElementById("notice");
    n.style.display = "none";
    n.textContent = "";
  }

  /**************** CSV Helpers ****************/
  function parseCSV(text) {
    // parser simple (maneja comillas)
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const n = text[i + 1];

      if (c === '"' && inQuotes && n === '"') { // "" -> "
        cur += '"'; i++;
      } else if (c === '"') {
        inQuotes = !inQuotes;
      } else if (c === "," && !inQuotes) {
        row.push(cur); cur = "";
      } else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && n === "\n") i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) {
      row.push(cur);
      rows.push(row);
    }

    // limpia filas vacías
    return rows.filter(r => r.some(x => (x ?? "").toString().trim() !== ""));
  }

  function normalizarHeader(h) {
    return (h || "")
      .toString()
      .trim()
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/[_-]+/g, " ");
  }

  function pickIndex(headersNorm, aliases) {
    for (const a of aliases) {
      const idx = headersNorm.indexOf(normalizarHeader(a));
      if (idx !== -1) return idx;
    }
    return -1;
  }

  function toNumberSafe(v) {
    const s = (v ?? "").toString().trim();
    if (!s) return 0;

    const cleaned = s
      .replace(/\s/g, "")
      .replace(/\.(?=\d{3}(\D|$))/g, "")
      .replace(",", ".");

    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function mapearDesdeSheet(rows, meta = { source: "Fuente" }) {
    if (!rows || !rows.length) return [];

    const headers = rows[0] || [];
    const headersNorm = headers.map(normalizarHeader);

    const iRUT        = pickIndex(headersNorm, ["RUT", "RUN"]);
    const iNOMBRE     = pickIndex(headersNorm, ["NOMBRE", "NOMBRE Y APELLIDO", "NOMBRES", "OPERADOR"]);
    const iFECHA      = pickIndex(headersNorm, ["FECHA", "FECHA EVALUACION", "TIMESTAMP", "HORA", "FECHA Y HORA"]);
    const iCARGO      = pickIndex(headersNorm, ["CARGO", "ROL"]);
    const iEQUIPO     = pickIndex(headersNorm, ["EQUIPO", "MAQUINA", "EQUIPO EVALUADO"]);
    const iCONTRATO   = pickIndex(headersNorm, ["CONTRATO", "PROYECTO", "FAENA"]);
    const iINSTRUCTOR = pickIndex(headersNorm, ["INSTRUCTOR", "EVALUADOR", "SUPERVISOR"]);
    const iTOTAL      = pickIndex(headersNorm, ["TOTALPUNTOS", "TOTAL PUNTOS", "TOTAL_PUNTOS", "PUNTOS", "TOTAL"]);
    const iNOTA       = pickIndex(headersNorm, ["NOTAFINAL", "NOTA FINAL", "NOTA_FINAL", "NOTA", "CALIFICACION"]);

    if ([iRUT, iNOMBRE, iTOTAL, iNOTA].some(i => i === -1)) {
      console.warn("Fuente ignorada por columnas mínimas faltantes:", meta.source, {
        headers_originales: headers,
        headers_normalizados: headersNorm,
        requeridas: { iRUT, iNOMBRE, iTOTAL, iNOTA }
      });
      return [];
    }

    const dataRows = rows
      .slice(1)
      .filter(r => r && (r[iRUT] || "").toString().trim() !== "");

    return dataRows.map(r => ({
      source: meta.source,
      rut:        (r[iRUT]        || "").toString().trim(),
      nombre:     (r[iNOMBRE]     || "").toString().trim(),
      fecha:      (r[iFECHA]      || "").toString().trim(),
      cargo:      (r[iCARGO]      || "").toString().trim(),
      equipo:     (r[iEQUIPO]     || "").toString().trim(),
      contrato:   (r[iCONTRATO]   || "").toString().trim(),
      instructor: (r[iINSTRUCTOR] || "").toString().trim(),
      totalPuntos: toNumberSafe(r[iTOTAL]),
      notaFinal:   toNumberSafe(r[iNOTA])
    }));
  }

  /**************** Carga de datos ****************/
  function validarURLs(){
    if (!CSV_URLS.length) {
      showNotice("No hay URLs en CSV_URLS. Pega tus links CSV publicados (Archivo → Publicar en la web → CSV).");
      return false;
    }
    for (const u of CSV_URLS) {
      if (u.includes("...")) {
        showNotice("Una URL tiene '...'. Eso rompe la carga. Pega el link completo CSV publicado.");
        return false;
      }
      if (u.includes("/edit")) {
        showNotice("Estás usando un link /edit. Debe ser /pub?...&output=csv (Publicar en la web).");
        return false;
      }
      if (!u.includes("output=csv")) {
        showNotice("Una URL no parece CSV (falta output=csv). Revisa el link publicado.");
        return false;
      }
    }
    hideNotice();
    return true;
  }

  async function cargarDatosMultiples() {
    
    const dotInpInit = document.getElementById("dotacionInput");
    if (dotInpInit) { dotInpInit.value = (localStorage.getItem("dotacionTotal") || dotInpInit.value || "108"); }
if (!validarURLs()) return;

    try {
      const resultados = await Promise.all(
        CSV_URLS.map(async (url) => {
          const res = await fetch(url, { cache: "no-store" });
          const txt = await res.text();
          return { url, txt, ok: res.ok, status: res.status };
        })
      );

      let todos = [];
      resultados.forEach(({url, txt, ok, status}, idx) => {
        const rows = parseCSV(txt);
        const mapped = mapearDesdeSheet(rows, { source: `Sheet ${idx+1}` });

        console.log(`Fuente ${idx+1}`, { ok, status, url, filasCSV: rows.length, registrosMapeados: mapped.length });
        todos = todos.concat(mapped);
      });

      registrosBase = todos;
      console.log("Registros combinados cargados:", registrosBase.length);

      if (!registrosBase.length) {
        showNotice("Cargó 0 registros. Abre F12 → Console y mira si alguna fuente quedó ignorada por columnas.");
      } else {
        hideNotice();
      }

      poblarFiltros(registrosBase);
      aplicarFiltros();

    } catch (err) {
      console.error("Error cargando datos:", err);
      showNotice("Error al leer las bases (probable CORS/permisos). Si abriste el archivo como file://, prueba abrirlo con un servidor local (http://localhost) o usa el botón \"Cargar CSV local\".");
    }
  }

  /**************** Filtros ****************/
  function poblarFiltros(reg) {
    const equipoSel = document.getElementById("equipoSel");
    const contratoSel = document.getElementById("contratoSel");
    const instructorSel = document.getElementById("instructorSel");

    const uniq = (arr) => [...new Set(arr.filter(Boolean).map(x => x.toString().trim()))].sort();

    const equipos = ["Todos", ...uniq(reg.map(r => r.equipo))];
    const contratos = ["Todos", ...uniq(reg.map(r => r.contrato))];
    const instructores = ["Todos", ...uniq(reg.map(r => r.instructor))];

    equipoSel.innerHTML = equipos.map(x => `<option>${x}</option>`).join("");
    contratoSel.innerHTML = contratos.map(x => `<option>${x}</option>`).join("");
    instructorSel.innerHTML = instructores.map(x => `<option>${x}</option>`).join("");

    equipoSel.onchange = aplicarFiltros;
    contratoSel.onchange = aplicarFiltros;
    instructorSel.onchange = aplicarFiltros;
  }

  function aplicarFiltros() {
    const rutQ = document.getElementById("rutInput").value.trim().toUpperCase();
    const equipo = document.getElementById("equipoSel").value;
    const contrato = document.getElementById("contratoSel").value;
    const instructor = document.getElementById("instructorSel").value;

    let f = [...registrosBase];

    if (rutQ) f = f.filter(r => (r.rut || "").toUpperCase().includes(rutQ));
    if (equipo && equipo !== "Todos") f = f.filter(r => r.equipo === equipo);
    if (contrato && contrato !== "Todos") f = f.filter(r => r.contrato === contrato);
    if (instructor && instructor !== "Todos") f = f.filter(r => r.instructor === instructor);

    registrosActuales = f;

    // reset page al filtrar
    page = 1;

    actualizarKPIs(registrosActuales);
    dibujarGraficos(registrosActuales);
    dibujarTabla(registrosActuales);
  }

  function limpiarFiltros() {
    document.getElementById("rutInput").value = "";
    document.getElementById("equipoSel").value = "Todos";
    document.getElementById("contratoSel").value = "Todos";
    document.getElementById("instructorSel").value = "Todos";
    aplicarFiltros();
  }

  function buscarRut() {
    aplicarFiltros();
  }

  /**************** KPIs ****************/
  function actualizarKPIs(reg) {
    document.getElementById("kpiRegistros").textContent = reg.length.toString();

    const uniqOp = new Set(reg.map(r => (r.rut || "") + "|" + (r.nombre || "")));
    document.getElementById("kpiOperadores").textContent = uniqOp.size.toString();
    // Avance dotación = operadores únicos / dotación total
    const dotInp = document.getElementById('dotacionInput');
    const dotacionTotal = Math.max(0, Number((dotInp && dotInp.value) || localStorage.getItem('dotacionTotal') || 108) || 0);
    if (dotInp) { dotInp.value = String(dotacionTotal || 108); }
    const avance = dotacionTotal ? (uniqOp.size / dotacionTotal) * 100 : 0;
    const elAv = document.getElementById('kpiAvanceDotacion');
    const elDot = document.getElementById('kpiDotacionTotal');
    if (elAv) elAv.textContent = (Math.round(avance * 10) / 10).toFixed(1) + '%';
    if (elDot) elDot.textContent = 'Sobre dotación total ' + (dotacionTotal || 108);


    const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

    const notas = reg.map(r => r.notaFinal || 0).filter(x => Number.isFinite(x));
    const puntos = reg.map(r => r.totalPuntos || 0).filter(x => Number.isFinite(x));

    document.getElementById("kpiPromNota").textContent = avg(notas).toFixed(1);
    document.getElementById("kpiPromPuntos").textContent = avg(puntos).toFixed(1);

    document.getElementById("kpiEquipos").textContent = new Set(reg.map(r => r.equipo).filter(Boolean)).size.toString();
    document.getElementById("kpiContratos").textContent = new Set(reg.map(r => r.contrato).filter(Boolean)).size.toString();
  }

  /**************** Gráficos ****************/
  function destroyChart(ch){ if (ch) ch.destroy(); }

  function dibujarGraficos(reg) {
    // Top 20 por nota
    const top = [...reg].sort((a,b)=> (b.notaFinal||0)-(a.notaFinal||0)).slice(0, 20);

    const labelsOper = top.map(r => (r.nombre || r.rut || "Sin nombre"));
    const notasOper = top.map(r => r.notaFinal || 0);
    const puntosOper = top.map(r => r.totalPuntos || 0);

    // Promedio por equipo
    const porEquipo = {};
    reg.forEach(r => {
      const k = r.equipo || "Sin equipo";
      porEquipo[k] = porEquipo[k] || { sum:0, n:0 };
      porEquipo[k].sum += (r.notaFinal || 0);
      porEquipo[k].n += 1;
    });
    const equipos = Object.keys(porEquipo);
    const promEquipo = equipos.map(k => porEquipo[k].n ? (porEquipo[k].sum/porEquipo[k].n) : 0);

    destroyChart(chartNotaOperador);
    destroyChart(chartPuntosOperador);
    destroyChart(chartPromEquipo);

    chartNotaOperador = new Chart(document.getElementById("chartNotaOperador"), {
      type: "bar",
      data: { labels: labelsOper, datasets: [{ label: "Nota final", data: notasOper }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true, max:100 } }
      }
    });

    chartPuntosOperador = new Chart(document.getElementById("chartPuntosOperador"), {
      type: "bar",
      data: { labels: labelsOper, datasets: [{ label: "Total puntos", data: puntosOper }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true } }
      }
    });

    chartPromEquipo = new Chart(document.getElementById("chartPromEquipo"), {
      type: "bar",
      data: { labels: equipos, datasets: [{ label: "Promedio nota", data: promEquipo }] },
      options: {
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true, max:100 } }
      }
    });
  }

  /**************** Tabla + paginación ****************/
  function setPageSize(v){
    pageSize = Number(v) || 25;
    page = 1;
    dibujarTabla(registrosActuales);
  }
  function prevPage(){
    if (page > 1) { page--; dibujarTabla(registrosActuales); }
  }
  function nextPage(){
    const totalPages = Math.max(1, Math.ceil(registrosActuales.length / pageSize));
    if (page < totalPages) { page++; dibujarTabla(registrosActuales); }
  }

  function dibujarTabla(reg) {
    const tbody = document.querySelector("#tabla-detalle tbody");
    tbody.innerHTML = "";

    const totalPages = Math.max(1, Math.ceil(reg.length / pageSize));
    if (page > totalPages) page = totalPages;

    const start = (page - 1) * pageSize;
    const slice = reg.slice(start, start + pageSize);

    document.getElementById("pageInfo").textContent =
      `Página ${page} de ${totalPages} — Mostrando ${slice.length} de ${reg.length}`;

    slice.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.rut)}</td>
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.fecha)}</td>
        <td>${esc(r.cargo)}</td>
        <td>${esc(r.equipo)}</td>
        <td>${esc(r.contrato)}</td>
        <td>${esc(r.instructor)}</td>
        <td>${(r.totalPuntos ?? 0)}</td>
        <td>${(r.notaFinal ?? 0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function esc(v){
    return (v ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /**************** Exportar PDF ****************/
  async function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    doc.setFontSize(14);
    doc.text("Dashboard Evaluaciones – Operadores", 40, 40);
    doc.setFontSize(10);
    doc.text("Generado desde el dashboard", 40, 58);

    const head = [["RUT","Nombre","Fecha","Cargo","Equipo","Contrato","Instructor","Total puntos","Nota final"]];
    const body = registrosActuales.map(r => [
      r.rut, r.nombre, r.fecha, r.cargo, r.equipo, r.contrato, r.instructor,
      String(r.totalPuntos ?? 0), String(r.notaFinal ?? 0)
    ]);

    doc.autoTable({
      startY: 80,
      head,
      body,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [17, 24, 39] }
    });

    doc.save("dashboard_evaluaciones.pdf");
  }


  async function cargarCSVsLocales(fileList){
    try{
      hideNotice();
      if(!fileList || !fileList.length){
        showNotice("No seleccionaste archivos CSV.");
        return;
      }
      const files = Array.from(fileList);
      let todos = [];
      for (let i=0;i<files.length;i++){
        const f = files[i];
        const txt = await f.text();
        const rows = parseCSV(txt);
        const mapped = mapearDesdeSheet(rows, { source: f.name || `CSV ${i+1}` });
        console.log("CSV local", { archivo: f.name, filasCSV: rows.length, registrosMapeados: mapped.length });
        todos = todos.concat(mapped);
      }
      registrosBase = todos;
      console.log("Registros combinados (local) cargados:", registrosBase.length);
      if (!registrosBase.length) {
        showNotice("Cargó 0 registros desde CSV local. Revisa que existan columnas mínimas (RUT, NOMBRE, TOTALPUNTOS/TOTAL PUNTOS, NOTAFINAL/NOTA FINAL).");
      } else {
        hideNotice();
      }
      poblarFiltros(registrosBase);
      aplicarFiltros();
    } catch(err){
      console.error("Error leyendo CSV local:", err);
      showNotice("No pude leer tus CSV locales. Abre F12 → Console para ver el error.");
    }
  }

  // Arranque
  window.addEventListener("load", cargarDatosMultiples);
</script>

</body>
</html>
